# This workflows will upload a Python Package using Twine when a release is created
# For more information see: https://help.github.com/en/actions/language-and-framework-guides/using-python-with-github-actions#publishing-to-package-registries

name: Test cpac

on:
  push

jobs:
  test_cpac_docker:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        go: [1.14]
        python: [3.6, 3.7, 3.8]
        platform: ['docker']
        tag: ['latest', 'dev-v1.8']

    steps:
    - uses: actions/checkout@v2
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ matrix.go }}
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python }}
    - name: Install dependencies
      run: |
        sudo apt-get install libarchive-dev \
        libffi-dev \
        flawfinder \
        libgpgme11-dev \
        libseccomp-dev \
        squashfs-tools \
        libssl1.1 libssl-dev \
        libuuid1 uuid-dev
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install coverage coveralls nipype
    - name: Install cpac
      run: cd $GITHUB_WORKSPACE && pip install -e .
    - name: Test cpac
      run: |
        coverage run --append -m pytest --doctest-modules --platform ${{ matrix.platform }} --tag ${{ matrix.tag }} .
        coverage report -m
    - name: Report coverage
      uses: AndreMiras/coveralls-python-action@v20201129
      with:
        parallel: True
        flag-name: Test cpac ${{ matrix.platform }} with Python {{ matrix.python }}
      continue-on-error: true
  test_cpac_singularity:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go: [1.14]
        python: [3.6, 3.7, 3.8]
        singularity: [3.6.4]
        platform: ['docker']
        tag: ['latest', 'dev-v1.8']

    steps:
    - uses: actions/checkout@v2
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ matrix.go }}
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python }}
    - name: Set up Singularity
      uses: eWaterCycle/setup-singularity@v5
      with:
        singularity-version: ${{ matrix.singularity }}
    - name: Install dependencies
      run: |
        sudo apt-get install libarchive-dev \
        libffi-dev \
        flawfinder \
        libgpgme11-dev \
        libseccomp-dev \
        squashfs-tools \
        libssl1.1 libssl-dev \
        libuuid1 uuid-dev
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install coverage coveralls nipype
    - name: Install cpac
      run: cd $GITHUB_WORKSPACE && pip install -e .
    - name: Test cpac
      run: |
        coverage run --append -m pytest --doctest-modules --platform ${{ matrix.platform }} --tag ${{ matrix.tag }} .
        coverage report -m
    - name: Report coverage
      uses: AndreMiras/coveralls-python-action@v20201129
      with:
        parallel: True
        flag-name: Test cpac ${{ matrix.platform }} with Python {{ matrix.python }}
      continue-on-error: true
  test_cpac_singularity:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go: [1.14]
        python: [3.6, 3.7, 3.8]
        singularity: [3.6.4]
        platform: ['singularity']

    steps:
    - uses: actions/checkout@v2
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ matrix.go }}
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python }}
    - name: Set up Singularity
      uses: eWaterCycle/setup-singularity@v5
      with:
        singularity-version: ${{ matrix.singularity }}
    - name: Install dependencies
      run: |
        sudo apt-get install libarchive-dev \
        libffi-dev \
        flawfinder \
        libgpgme11-dev \
        libseccomp-dev \
        squashfs-tools \
        libssl1.1 libssl-dev \
        libuuid1 uuid-dev
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install coverage coveralls nipype
    - name: Install cpac
      run: cd $GITHUB_WORKSPACE && pip install -e .
    - name: Test cpac
      run: |
        coverage run --append -m pytest --doctest-modules --platform ${{ matrix.platform }} .
        coverage report -m
    - name: Report coverage
      uses: AndreMiras/coveralls-python-action@v20201129
      with:
        parallel: True
        flag-name: Test cpac ${{ matrix }}
      continue-on-error: true
  finalize_coverage-report:
    needs: 
      - test_cpac_docker
      - test_cpac_singularity
    runs-on: ubuntu-latest
    steps:
    - name: Finalize coverage report
      uses: AndreMiras/coveralls-python-action@v20201129
      with:
        parallel-finished: true
      continue-on-error: true
  update_README:
    # Only update README if tests succeed
    needs: 
      - test_cpac_docker
      - test_cpac_singularity
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install cpac
      run: cd $GITHUB_WORKSPACE && pip install .
    - name: Configure Git credentials
      uses: oleksiyrudenko/gha-git-credentials@v2.1
      with:
        global: true
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Update README
      run: bash ${GITHUB_WORKSPACE}/.github/workflows/update_README_usage.sh
